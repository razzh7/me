---
title: docker éƒ¨ç½²åšå®¢è‡³é˜¿é‡Œäº‘
date: 2025-02-07
category: blog
---

## å†™åœ¨ä¹‹å‰

æœ¬æ–‡ä¸»è¦è®°å½•äº†ä½œè€…å¦‚ä½•éƒ¨ç½²å½“å‰åšå®¢åˆ°äº‘æœåŠ¡å™¨çš„è¿‡ç¨‹ï¼Œåˆ†ä¸ºä»¥ä¸‹ä¸¤ä¸ªé˜¶æ®µï¼š

- `acme.sh` ä¸º `docker` ä¸­çš„ `Nginx` æ·»åŠ  SSL è¯ä¹¦
- `Github Actions` ä»»åŠ¡æµè‡ªåŠ¨ä¸Šä¼ æäº¤ä»£ç çš„æ‰“åŒ…ç‰ˆæœ¬è‡³æœåŠ¡å™¨æŒ‡å®šç›®å½•

æ•´ç¯‡æ•™ç¨‹ä»¥ `docker` ä¸ºåŸºç¡€æ¥éƒ¨ç½²åšå®¢è‡³é˜¿é‡Œäº‘

### acme.sh

[acme.sh](https://github.com/acmesh-official/acme.sh)æ˜¯ github ä¸Šçš„ä¸€ä¸ªå¼€æºé¡¹ç›®ï¼Œç›®å‰ä»¥æœ‰41KğŸŒŸï¼Œacme åè®®æ˜¯ `Letâ€™s Encrypt` å’Œå…¶ä»– `CA` æœºæ„ä½¿ç”¨çš„ä¸€ç§ç½‘ç»œäº¤äº’åè®®ï¼Œç”¨äºè‡ªåŠ¨éªŒè¯ç½‘ç«™/åŸŸåå¹¶é¢å‘ SSL/TLS è¯ä¹¦ã€‚

åœ¨ç­¾å‘è¯ä¹¦åå¯åŒæ—¶åˆ›å»ºå®šæ—¶ä»»åŠ¡ï¼Œåœ¨è¯ä¹¦å°†è¦è¿‡æœŸæ—¶è‡ªåŠ¨é‡æ–°ç”³è¯·å¹¶éƒ¨ç½²ï¼Œå…¶è¿˜å¯ä»¥äº Nginx æˆ–è€… Apache ç›´æ¥äº¤äº’å®Œæˆè¯ä¹¦ç”³è¯·è¿‡ç¨‹ã€‚

### docker

å¦‚æœäº‘æœåŠ¡å™¨ä¸Šè¿˜æ²¡å®‰è£…dockerï¼Œå¯ä»¥æŒ‰ç…§é˜¿é‡Œäº‘[æ–‡æ¡£](https://help.aliyun.com/zh/ecs/use-cases/install-and-use-docker) æä¾›çš„æ–¹æ³•å®‰è£…ã€‚

`docker`çš„æŒ‡ä»¤å¯ä»¥è§[æ–‡æ¡£](https://docs.docker.com/reference/cli/docker/)

é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨ docker æ‹‰å–ä¸€ä¸ª Nginx é•œåƒï¼š

```shell showLineNumbers
docker container run \
  -d \
  --rm \
  --name mynginx \
  nginx
docker container cp mynginx:/etc/nginx .
mv nginx conf
mkdir ./conf/certs
mkdir html
docker stop mynginx
```

è¿™ä¸€æ­¥çš„ä½œç”¨æ˜¯è¿è¡Œ docker å®¹å™¨ä¸­çš„ nginxï¼Œå¤åˆ¶ nginx çš„ç›®å½•æ–‡ä»¶è‡³å½“å‰ç›®å½•ï¼Œå¹¶åˆ›å»º `certs` ç›®å½•å’Œ `html` ç›®å½•ï¼Œç›®çš„æ˜¯ä¸ºåç»­ä¸ docker å®¹å™¨å†…çš„ nginx åšæ•°æ®å·(æ˜ å°„)ã€‚

`certs` ç›®å½•æ˜¯ç”¨æ¥åœ¨å­˜æ”¾è¯ä¹¦çš„ç›®å½•ï¼Œè€Œ `html` ç›®å½•åˆ™æ˜¯å­˜æ”¾æˆ‘ä»¬åšå®¢æ‰“åŒ…åèµ„æºçš„ç›®å½•ã€‚

```shell showLineNumbers
docker container run \
  --rm \
  --name mynginx_1 \
  --volume "$PWD/html":/usr/share/nginx/html \
  --volume "$PWD/conf":/etc/nginx \
  --label=sh.acme.autoload.domain=razzh.cn \
  -p 80:80 \
  -p 443:443 \
  -d \
  nginx
```

> å› ä¸ºHTTPå’ŒHTTPSçš„é»˜è®¤ç«¯å£æ˜¯80å’Œ443ï¼Œäº‘æœåŠ¡å™¨éœ€è¦åœ¨å®‰å…¨ç»„æ‰‹åŠ¨æ·»åŠ 80å’Œ443ç«¯å£ï¼Œæ‰èƒ½å®Œæˆåç»­çš„æˆåŠŸè®¿é—®ã€‚

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æŒ‰ç…§ `acme.sh` æä¾›çš„ [dockeréƒ¨ç½²æ–‡æ¡£](https://github.com/acmesh-official/acme.sh/wiki/deploy-to-docker-containers) æ¥æ“ä½œã€‚

```shell showLineNumbers
docker container run \
  --name mynginx_1 \
  --volume "$PWD/html":/usr/share/nginx/html \
  --volume "$PWD/conf":/etc/nginx \
  --label=sh.acme.autoload.domain=razzh.cn \
  -d \
  nginx
```

æ–‡æ¡£ä¸­è¦æ±‚æˆ‘ä»¬ä½¿ç”¨ `docker` è¿è¡Œä¸€ä¸ª `nginx`ï¼Œå¹¶æ‰“ä¸Š `label` æ ‡ç­¾ï¼Œå› ä¸ºåç»­acme.shåœ¨éƒ¨ç½²çš„æ—¶å€™éœ€è¦ç”¨ `label` å»æ‰¾åˆ°è¿™ä¸ªå®¹å™¨ã€‚

#### 1. å‘é˜¿é‡Œäº‘ç”³è¯·API

åœ¨[è¿™é‡Œ](https://ak-console.aliyun.com/#/accesskey)ç®€å•çš„ç™»å½•åï¼Œç”³è¯·ä¸€ä¸ª`AccessKey ID`å’Œ`Access Key Secret`ï¼Œå¦¥å–„ä¿å­˜ã€‚

#### 2. åˆ›å»º acme.sh å®¹å™¨

ä¸‹é¢çš„å‘½ä»¤å°†åœ¨å½“å‰ç›®å½•åˆ›å»ºä¸€ä¸ª `out` ç›®å½•å­˜æ”¾ä¸€äº›è¯ä¹¦æ–‡ä»¶ï¼Œä½†æˆ‘ä»¬å°†ä¸ä¼šç›´æ¥ä½¿ç”¨è¿™äº›æ–‡ä»¶

```shell showLineNumbers
docker run --rm  -itd \
    -v "$(pwd)/out":/acme.sh \
    --net=host \
    --name=acme.sh   \
    -v /var/run/docker.sock:/var/run/docker.sock \
    neilpang/acme.sh daemon
```

#### 3. ä½¿ç”¨acme.shç”³è¯·è¯ä¹¦

å°†`Ali_Key`å’Œ`Ali_Secret`æ›¿æ¢ä¸ºä½ åœ¨æœ¬èŠ‚ç¬¬ä¸€æ­¥ç”³è¯·çš„ `AccessKey ID` å’Œ `Access Key Secret`ï¼Œå¹¶å°† `example.com` æ›¿æ¢ä¸ºä½ çš„åŸŸåï¼Œæ‰§è¡Œï¼Œä½ ä¼šçœ‹åˆ° `checking` çš„å­—æ ·ï¼Œè¿™æ—¶ `CA` æ­£åœ¨é¢å‘è¯ä¹¦ï¼Œç¨ç­‰ä¸¤åˆ†é’Ÿï¼Œä¹‹åå¼¹å‡º `success` ä¹‹ç±»çš„æç¤ºè¯ï¼Œé‚£ä¹ˆè¯´æ˜ï¼Œç”³è¯·è¯ä¹¦æˆåŠŸäº†ï¼ï½

`example.com` ä¸€çº§åŸŸåå’Œå®ƒçš„äºŒçº§åŸŸå `*.example.com`ï¼Œéƒ½å¯ä»¥ä½¿ç”¨åŒä¸€è¯ä¹¦ã€‚

```shell showLineNumbers
docker  exec \
    -e Ali_Key="ä½ çš„Key" \
    -e Ali_Secret="ä½ çš„Secret"  \
    acme.sh --issue -d example.com -d "*.example.com" --dns dns_ali --server letsencrypt
```

#### 4. ä½¿ç”¨acme.shè‡ªåŠ¨éƒ¨ç½²è¯ä¹¦

æ³¨æ„ï¼Œ`sh.acme.autoload.domain`çš„å€¼éœ€è¦ä¸ä½ è¿è¡Œçš„ `nginx` å®¹å™¨ `label` å€¼ä¸€è‡´ï¼Œå¹¶æŠŠ**æ–‡ä»¶è·¯å¾„**ã€**åŸŸå**æ›¿æ¢æˆè‡ªå·±çš„ã€‚

```shell showLineNumbers
docker  exec \
    -e DEPLOY_DOCKER_CONTAINER_LABEL=sh.acme.autoload.domain=razzh.cn  \
    -e DEPLOY_DOCKER_CONTAINER_KEY_FILE=/etc/nginx/certs/razzh.cn/key.pem   \
    -e DEPLOY_DOCKER_CONTAINER_CERT_FILE="/etc/nginx/certs/razzh.cn/cert.pem"  \
    -e DEPLOY_DOCKER_CONTAINER_CA_FILE="/etc/nginx/certs/razzh.cn/ca.pem"   \
    -e DEPLOY_DOCKER_CONTAINER_FULLCHAIN_FILE="/etc/nginx/certs/razzh.cn/full.pem"  \
    -e DEPLOY_DOCKER_CONTAINER_RELOAD_CMD="service nginx force-reload"   \
    acme.sh --deploy -d razzh.cn  --deploy-hook docker
```

#### æµ‹è¯• SSH

è¯ä¹¦åªæœ‰3ä¸ªæœˆæœ‰æ•ˆæœŸï¼Œæˆ‘ä»¬åœ¨ç¬¬å››æ­¥å·²ç»åšäº†è‡ªåŠ¨ç»­æœŸçš„æ“ä½œï¼Œåœ¨è¯ä¹¦å¿«åˆ°æœŸçš„æ—¶å€™ `acme.sh` ä¼šè‡ªåŠ¨ç»­æœŸã€‚

### Nginx é…ç½®

`SSH` è¯ä¹¦å·²ç»éƒ¨ç½²å®Œæˆï¼Œæˆ‘ä»¬è¿˜éœ€è¦é…ç½® `Nginx` æ¥ç›‘å¬80å’Œ443æ¥å£ï¼Œé«˜äº®çš„è¡Œå¿…é¡»è·Ÿ `docker` ä¸­ `nginx` ä¸­åˆ›å»ºæ•°æ®å·(æ˜ å°„)æ—¶çš„è·¯å¾„ä¸€è‡´ï¼Œç½‘ç«™ä¹Ÿè¦æ›¿æ¢æˆè‡ªå·±çš„ã€‚

```nginx showLineNumbers {4,17,19,20,34}
#/etc/conf/conf.d/razzh.cn.conf 
server {
    listen       80;
    server_name  razzh.cn;

    #80è·³è½¬åˆ°443
    rewrite ^(.*)$ https://${server_name}$1 permanent;

    error_page   500 502 503 504  /50x.html;
    location = /50x.html {
        root   /usr/share/nginx/html;
    }
}

server {
    listen 443 ssl http2;
    server_name  razzh.cn;

    ssl_certificate          /etc/nginx/certs/razzh.cn/full.pem;
    ssl_certificate_key      /etc/nginx/certs/razzh.cn/key.pem;

    ssl_session_timeout  5m;

    #å¼€å¯HSTS
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;

    ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES256-GCM-SHA384;
    #é€‚æ—¶ç§»é™¤TLSv1.2
    ssl_protocols TLSv1.3 TLSv1.2;
    ssl_prefer_server_ciphers on;
    ssl_session_cache shared:SSL:10m;

    location / {
        root   /usr/share/nginx/html/blog/out;
        index  index.html index.htm;
    }

}
```

ä¿å­˜å¥½é…ç½®åï¼Œæˆ‘ä»¬æ‰§è¡Œå‘½ä»¤é‡å¯ä¸€ä¸‹ `docker` ä¸­çš„ `nginx` å³å¯

```shell
docker container restart mynginx_1
```
### Github Actions éƒ¨ç½²

è¦ä½¿ç”¨å·¥ä½œæµï¼Œæˆ‘ä»¬éœ€è¦åœ¨é¡¹ç›®è·Ÿç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ª `.github/workflows` çš„ç›®å½•å¹¶æ·»åŠ  `deploy.yml` çš„æ–‡ä»¶ï¼Œæ–‡ä»¶åå¯ä»¥éšä¾¿èµ·ã€‚

```yml showLineNumbers
name: Deploy

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build:
    # è¿è¡Œåœ¨ubuntuä¸Š
    runs-on: ubuntu-latest

    # ä»»åŠ¡æµæ­¥éª¤
    steps:
      - name: æ‹‰å–ä»£ç 
        uses: actions/checkout@v4

      - name: å®‰è£…NodeJS
        uses: actions/setup-node@v4
        with:
          node-version: 20
      - run: npm install -g pnpm
      - run: pnpm install
      - run: pnpm build

      - name: éƒ¨ç½²åšå®¢
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.REMOTE_HOST }}
          username: ${{ secrets.REMOTE_USER }}
          password: ${{ secrets.REMOTE_PASS }}
          port: 22
          # æœ¬åœ°æ‰“åŒ…åçš„ç›®å½•
          source: './out/'
          # æœåŠ¡å™¨å­˜æ”¾distçš„ç›®å½•
          target: ${{ secrets.REMOTE_TARGET }}
```
ä¸ºäº†å®‰å…¨æ€§è€ƒè™‘ï¼ŒæœåŠ¡å™¨çš„ä¿¡æ¯ä¸èƒ½å¯¹å¤–æš´éœ²ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦è®¾ç½® `secrets` å˜é‡ï¼Œ`secrets` å˜é‡å¯åœ¨ `Github` ä¸­çš„ **Settings -> Secrets and variables -> actions** ä¸­é…ç½®ã€‚

## å‚è€ƒ

[å…¨å‘˜dockeråŒ–ï¼ä½¿ç”¨dockerä¸­çš„acme.shä¸ºdockerä¸­çš„Nginxæ·»åŠ SSLè¯ä¹¦](https://blog.iyu.icu/posts/acmesh_docker/#)
[Github Actions æ–‡æ¡£](https://docs.github.com/zh/actions/writing-workflows/quickstart)

