---
title: docker éƒ¨ç½² Twist Icons æ–‡æ¡£
date: 2025-02-17
category: blog
---

æœ¬æ–‡å¼€å§‹ä¹‹å‰ï¼Œå®¹æˆ‘ä»‹ç»ä¸€ä¸‹è¿™ç¯‡æ–‡ç« çš„èƒŒæ™¯ã€‚  

æœ¬æ–‡è®°å½•äº†ä½œè€…éƒ¨ç½² [Twist Icons æ–‡æ¡£](https://icons.razzh.cn) çš„è¿‡ç¨‹ã€‚  

- å›½å†…ç«™ç‚¹ï¼š[icons.razzh.cn](https://icons.razzh.cn)
- å›½å¤–ç«™ç‚¹ï¼š[twist-icons-docs.vercel.app](https://twist-icons-docs.vercel.app/)

é¦–å…ˆ Twist Iconsï¼Œæˆ‘ç”±æœ¬äººå¼€å‘çš„ Icons åº“ï¼Œæ‰“åŒ…äº†è®¸å¤šçŸ¥åå›¾æ ‡åº“çš„å›¾æ ‡ï¼Œå…·ä½“ä»‹ç»å¯ä»¥è§‚çœ‹è¿™ç¯‡æ–‡ç« ï¼š[ä¼ é€é—¨](https://razzh.cn/posts/twist-icons/)ã€‚  

è¿™æ¬¡æ‰“åŒ…çš„é¡¹ç›®æ˜¯åŸºäº docker æ‰“åŒ…çš„ï¼Œæ‰€ä»¥å¸Œæœ›ä½ æ‹¥æœ‰ `docker` ç›¸å…³çš„åŸºç¡€çŸ¥è¯†ï¼Œå¹¶æŒ‰ç…§å®˜æ–¹æä¾›çš„[é¡¹ç›®ç¤ºä¾‹](https://github.com/vercel/next.js/tree/canary/examples/with-docker)é…åˆ `docker` æ‰“åŒ…æˆ‘ä»¬çš„é¡¹ç›®ã€‚  

æ•´ä½“æ€è·¯æ˜¯æŠŠæ‰“åŒ… `NextJS` çš„ä»£ç å¹¶åœ¨ `docker` é‡Œé¢è·‘èµ·æ¥ï¼Œå¹¶é…ç½® `Nginx` åå‘ä»£ç†åˆ° docker å®¹å™¨ä¸­å¯åŠ¨çš„åœ°å€ä¸Šã€‚

## å¼€å§‹æ“ä½œï¼

### æ·»åŠ  Nextjs é…ç½®

æ–‡æ¡£ä¸­è®©æˆ‘ä»¬å…ˆé…ç½® `next.config.js` ä¸­çš„ `output` å­—æ®µï¼Œå°†å…¶è®¾ç½®æˆ `standalone`ï¼Œè®¾ç½®æˆè¿™æ ·çš„ç›®çš„æ˜¯ä»€ä¹ˆï¼Ÿ  

æˆ‘åœ¨å®˜æ–¹æ–‡æ¡£æ‰¾åˆ°äº†è¯´æ˜ï¼š**Next.js can automatically create a standalone folder that copies only the necessary files for a production deployment including select files in node_modules.**  

æ€»ç»“ä¸€ä¸‹å°±æ˜¯å¸®æˆ‘ä»¬å‡å°‘æ‰“åŒ…ä½“ç§¯çš„ï¼Œæˆ‘ä»¬æ·»åŠ ä¸Šå°±å¥½ã€‚

### æ·»åŠ  Dockerfile

```Dockerfile showLineNumbers
# syntax=docker.io/docker/dockerfile:1

FROM node:20-alpine AS base

# Install dependencies only when needed
FROM base AS deps
# Check https://github.com/nodejs/docker-node/tree/b4117f9333da4138b03a546ec926ef50a31506c3#nodealpine to understand why libc6-compat might be needed.
RUN apk add --no-cache libc6-compat
WORKDIR /app

# Install dependencies based on the preferred package manager
COPY package.json yarn.lock* package-lock.json* pnpm-lock.yaml* .npmrc* ./
RUN \
  if [ -f yarn.lock ]; then yarn --frozen-lockfile; \
  elif [ -f package-lock.json ]; then npm ci; \
  elif [ -f pnpm-lock.yaml ]; then corepack enable pnpm && pnpm i --frozen-lockfile; \
  else echo "Lockfile not found." && exit 1; \
  fi


# Rebuild the source code only when needed
FROM base AS builder
WORKDIR /app
COPY --from=deps /app/node_modules ./node_modules
COPY . .

# Next.js collects completely anonymous telemetry data about general usage.
# Learn more here: https://nextjs.org/telemetry
# Uncomment the following line in case you want to disable telemetry during the build.
# ENV NEXT_TELEMETRY_DISABLED=1

RUN \
  if [ -f yarn.lock ]; then yarn run build; \
  elif [ -f package-lock.json ]; then npm run build; \
  elif [ -f pnpm-lock.yaml ]; then corepack enable pnpm && pnpm run build; \
  else echo "Lockfile not found." && exit 1; \
  fi

# Production image, copy all the files and run next
FROM base AS runner
WORKDIR /app

ENV NODE_ENV=production
# Uncomment the following line in case you want to disable telemetry during runtime.
# ENV NEXT_TELEMETRY_DISABLED=1

RUN addgroup --system --gid 1001 nodejs
RUN adduser --system --uid 1001 nextjs

COPY --from=builder /app/public ./public

# Automatically leverage output traces to reduce image size
# https://nextjs.org/docs/advanced-features/output-file-tracing
COPY --from=builder --chown=nextjs:nodejs /app/.next/standalone ./
COPY --from=builder --chown=nextjs:nodejs /app/.next/static ./.next/static

USER nextjs

EXPOSE 2010

ENV PORT=2010

# server.js is created by next build from the standalone output
# https://nextjs.org/docs/pages/api-reference/config/next-config-js/output
ENV HOSTNAME="0.0.0.0"
CMD ["node", "server.js"]
```

æˆ‘ç›´æ¥ä½¿ç”¨çš„ `Dockerfile` æ–‡ä»¶ï¼Œåªå¯¹Nodeç‰ˆæœ¬å’Œç«¯å£è¿›è¡Œäº†ä¿®æ”¹ï¼Œæˆ‘æŒ‡å®šäº†Nodeç‰ˆæœ¬ä¸º20ï¼Œç«¯å£å·é»˜è®¤æ˜¯3000ï¼Œä½ å¯ä»¥ä¿®æ”¹æˆå…¶ä»–çš„ï¼Œæˆ‘è¿™é‡Œæ˜¯ä¿®æ”¹æˆäº† 2010ï¼Œä½†è¦è®°å¾—æˆ‘ä»¬éœ€è¦åœ¨ `package.json` ä¸­åŒæ­¥ä¿®æ”¹ `start` å‘½ä»¤ï¼š

```json showLineNumbers
"start": "next start -p 2010",
```

### æœ¬åœ°åˆ¶ä½œé•œåƒ

æˆ‘ä»¬åˆ©ç”¨ `Dockerfile` æ–‡ä»¶åˆ¶ä½œ docker é•œåƒï¼Œæˆ‘ä½¿ç”¨çš„ç¯å¢ƒæ˜¯ `MacOS M1`ã€‚  

```bash showLineNumbers
docker buildx build --platform=linux/amd64 -t twist-icons --no-cache .
```

è¿™é‡ŒæŒ‡å®šäº†é•œåƒå¯¹åº”çš„å¹³å° `linux/amd64`ï¼Œæ‰“åŒ…å‡ºæ¥çš„é•œåƒå…¼å®¹æ€§å¥½ï¼Œå¯ä»¥è¿è¡Œåœ¨ `linux/amd64/v8` å’Œ `linux/amd64/v4` çš„æœºå™¨ä¸Šã€‚  

éœ€è¦ç¨ç­‰å‡ åˆ†é’Ÿï¼Œå› ä¸º `Twist Icons` æ”¶é›†äº†éå¸¸å¤šçš„æœ¬åœ°å›¾æ ‡ï¼Œé‡‡ç”¨çš„æ˜¯ `NextJS` çš„**é™æ€(Static)æ‰“åŒ…**æ–¹æ¡ˆï¼Œæ‰€ä»¥ç”Ÿæˆçš„é™æ€HTMLä¼šéå¸¸å¤§ï¼Œæ‰“åŒ…æ¯”è¾ƒè€—æ—¶ä¸”å ç”¨æœºå™¨èµ„æºã€‚

> ä¸ºä»€ä¹ˆä¸åœ¨æœåŠ¡å™¨ä¸Šæ„å»ºé•œåƒï¼Ÿ  
æˆ‘å°è¯•è¿‡åœ¨æœåŠ¡å™¨ä¸­ç›´æ¥æ„å»ºDokceré•œåƒï¼Œç»“æœæ˜¯å¤±è´¥çš„ã€‚å› ä¸ºåœ¨æ„å»º Twist Icons Docs çš„é•œåƒå ç”¨çš„å¤§é‡çš„å†…å­˜ï¼Œæˆ‘çš„æœåŠ¡å™¨æ˜¯2æ ¸2GBçš„ï¼Œä¸Šæ–‡è¯´è¿‡æ‰“åŒ…è¿™æ ·çš„é¡¹ç›®ä¼šå ç”¨å¤§é‡çš„å†…å­˜èµ„æºï¼Œæ•…æ‰“åŒ…é•œåƒå¤±è´¥äº†ï¼Œæ‰€ä»¥é‡‡ç”¨è¿ç”¨æœ¬åœ°æœºå™¨çš„ç®—åŠ›æ¥æ‰“åŒ…é•œåƒã€‚  
  
> å¦‚æœæœåŠ¡å™¨é…ç½®å…è®¸ï¼Œå¯ä»¥ç›´æ¥åœ¨æœåŠ¡å™¨ä¸Šé…ç½® `git` æ‹‰å–æœ€æ–°ä»£ç åœ¨äº‘ä¸Šæ‰“åŒ… docker é•œåƒè¿è¡Œã€‚

### ä¿å­˜é•œåƒ

å› ä¸ºæœ¬åœ°é•œåƒä¸æ”¯æŒç›´æ¥ä¸Šä¼ åˆ°æœåŠ¡å™¨ï¼Œæ‰€ä»¥æˆ‘ä»¬æ‰“åŒ…æˆ `tar` æ ¼å¼å†ä¸Šä¼ åˆ°æœåŠ¡å™¨è¿›è¡Œè§£å‹ã€‚

```bash showLineNumbers
docker save -o twist-icons.tar twist-icons:latest
```

### åŠ è½½é•œåƒ

æˆ‘ä»¬é€šè¿‡ `scp` å·¥å…·ä¸Šä¼ æ–‡ä»¶åˆ°æœåŠ¡å™¨ä¸Šï¼Œæˆ‘è¿™é‡Œæ˜¯ä¸Šä¼ åˆ°äº† `/home` ç›®å½•ä¸‹ã€‚  

ç„¶åæˆ‘ä»¬å°±å¯ä»¥è¿ç”¨ `docker load` æ¥åŠ è½½é•œåƒäº†ã€‚

```bash showLineNumbers
docker save -o twist-icons.tar twist-icons:latest
```

### è¿è¡Œé•œåƒ

ç«¯å£å· A:Bï¼Œå…¶ä¸­ç«¯å£å·Aæ˜¯å¤–éƒ¨è®¿é—®æœåŠ¡å™¨çš„ç«¯å£å·ï¼Œä½ éœ€è¦åœ¨é˜¿é‡Œäº‘çš„æœåŠ¡å™¨å®‰å…¨ç»„å¼€æ”¾è¿™ä¸ªç«¯å£ï¼Œæˆ‘è¿™é‡Œæ˜¯è®¾ç½®äº†2010ã€‚  

ç«¯å£å· Bï¼Œæ˜¯ä¹‹å‰è¿è¡Œ `Dockerfile` æ–‡ä»¶æš´éœ²(EXPOSE)çš„ç«¯å£å·ï¼Œéœ€è¦ä¸å…¶ä¸€è‡´ã€‚

```bash showLineNumbers
docker run -d --rm -p 2010:2010 twist-icons:latest
```

### Nginx é…ç½®

è¿™é‡Œä¸€æ ·æ˜¯è¿è¡Œ `docker` çš„ `nginx`ï¼Œ[ä¸Šæ–‡](https://razzh.cn/posts/deploy/)æˆ‘ä»¬éƒ¨ç½²äº†åšå®¢åœ¨ `Nginx` ä¸­ã€‚

```bash showLineNumbers
docker container run \
  --rm \
  --name mynginx_1 \
  --volume "$PWD/html":/usr/share/nginx/html \
  --volume "$PWD/conf":/etc/nginx \
  --label=sh.acme.autoload.domain=razzh.cn \
  --add-host=host.docker.internal:host-gateway \
  -p 80:80 \
  -p 443:443 \
  -d \
  nginx
```

è¿™é‡Œçš„å¯åŠ¨é¡¹é…ç½®è¾ƒä¸Šæ–‡çš„å¯åŠ¨é…ç½®æ–°å¢ `--add-host` é€‰é¡¹ï¼ŒåŸå› æ˜¯æˆ‘å°è¯•è¿‡åœ¨ `conf` çš„åå“ä»£ç†é€‰é¡¹ `proxy_pass` çš„æ—¶å€™å°† `icons.razzh.cn` ä»£ç†åˆ° `http:127.0.0.1:2010` è¿™ä¸ªåœ°å€ä¸Šï¼Œä½†æ˜¯è®¿é—®æ—¶æœåŠ¡å™¨å´å“åº”çš„æ˜¯**502**æŠ¥é”™ã€‚  

é€šè¿‡ä½¿ç”¨ `docker logs` å‘½ä»¤ï¼Œæˆ‘ä»¬æ‰“å°å®¹å™¨çš„é”™è¯¯æ—¥å¿—ï¼š  

```bash showLineNumbers
docker logs -f <container_id>
```

è·Ÿç€é”™è¯¯æç¤ºï¼Œé¡ºè—¤æ‘¸ç“œåœ¨è¿™ä¸ª [Stackflow](https://stackoverflow.com/questions/31324981/how-to-access-host-port-from-docker-container) ä¸‹æ‰¾åˆ°äº†ç­”æ¡ˆï¼š

<ImagePreview src='/img/deploy-icons-issue.webp' />  

å•å•ä¿®æ”¹é…ç½®æ˜¯ä¸èƒ½è§£å†³é—®é¢˜çš„  

**This won't work automatically, but you need to provide the following run flag**  

åº•ä¸‹çš„è€å“¥è¯„è®ºè¡¥å……é“ï¼šæˆ‘ä»¬è¿˜éœ€è¦åœ¨è¿è¡Œé•œåƒçš„æ—¶å€™æ·»åŠ è¿™ä¸ªé…ç½®ï¼Œæ‰€ä»¥æˆ‘ä»¬æ·»åŠ ä¸Šäº†è¿™ä¸ªé…ç½®ï¼Œé—®é¢˜è§£å†³äº†ï½  

æ‰€ä»¥å®Œæ•´çš„ Nginx é…ç½®å¦‚ä¸‹ï¼š

```nginx showLineNumbers
#/etc/conf/conf.d/icons.razzh.cn.conf 
server {
    listen       80;
    server_name  icons.razzh.cn;

    #80è·³è½¬åˆ°443
    rewrite ^(.*)$ https://${server_name}$1 permanent;

    error_page   500 502 503 504  /50x.html;
    location = /50x.html {
        root   /usr/share/nginx/html;
    }
}

server {
    listen 443 ssl http2;
    server_name  icons.razzh.cn;

    ssl_certificate          /etc/nginx/certs/razzh.cn/full.pem;
    ssl_certificate_key      /etc/nginx/certs/razzh.cn/key.pem;

    ssl_session_timeout  5m;

    #å¼€å¯HSTS
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;

    ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES256-GCM-SHA384;
    #é€‚æ—¶ç§»é™¤TLSv1.2
    ssl_protocols TLSv1.3 TLSv1.2;
    ssl_prefer_server_ciphers on;
    ssl_session_cache shared:SSL:10m;

    location / {
        root /usr/share/nginx/html;
        proxy_pass http://host.docker.internal:2010;
        index index.html index.htm;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "Upgrade";
    }
}
```

é…ç½®å®Œæˆåæˆ‘ä»¬é‡æ–°å¯åŠ¨ä¸€ä¸‹ `Nginx` å®¹å™¨ï¼Œæˆ‘ä»¬çš„é…ç½®å°±ç”Ÿæ•ˆäº†ã€‚

```bash showLineNumbers
docker restart container name
```

## docker æ— æ³•æ‹‰å–é•œåƒ

æœ€åè¡¥å……ä¸€ä¸‹è¸©çš„å‘å§ï¼Œå¦‚æœæƒ³åœ¨æœ¬åœ°åˆ¶ä½œä¸€ä¸ª docker é•œåƒï¼Œ`docker hub` åœ¨å›½å†…æ—¶å¸¸è®¿é—®ä¸äº†ï¼Œæ‰“åŒ…è¿‡ç¨‹æŠ›å‡ºç±»ä¼¼ `auth`ã€`token` ä¸å¯è®¿é—®çš„é—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ `docker desktop` ä¸­çš„è®¾ç½® `é•œåƒæº`ã€‚  

å…·ä½“è·¯å¾„ï¼šSettings -> Docker Engine ä¸­æ·»åŠ é•œåƒæºï¼Œæˆªæ­¢åœ¨å‘æ–‡å‰è¿™ä¸ªé•œåƒæºæ˜¯å¯ä»¥ä½¿ç”¨çš„ï¼Œä½†æ˜¯å¯èƒ½ä¹Ÿä¼šå¤±æ•ˆï¼Œåˆ°æ—¶å€™éœ€è¦è‡ªå·± google ä¸€ä¸‹å¯ç”¨çš„é•œåƒæºæ›´æ–°ä¸€ä¸‹å°±è¡Œäº†ã€‚  

```json showLineNumbers {12,13,14}
{
  "builder": {
    "gc": {
      "defaultKeepStorage": "20GB",
      "enabled": true
    }
  },
  "experimental": false,
  "features": {
    "buildkit": true
  },
  "registry-mirrors": [
    "https://docker.1ms.run"
  ]
}
```

å¦‚æœæ˜¯æƒ³é…ç½®æœåŠ¡å™¨ä¸Šçš„ `docker` é•œåƒï¼Œå¯ä»¥ç›´æ¥ä¿®æ”¹ `/etc/docker/daemon.json` æ–‡ä»¶ï¼Œæ·»åŠ  `registry-mirrors` å­—æ®µå°±å¯ä»¥äº†ã€‚  

``` bash showLineNumbers
sudo mkdir -p /etc/docker
sudo tee /etc/docker/daemon.json <<-'EOF'
{
  "registry-mirrors": ["https://rh65k0v7.mirror.aliyuncs.com"]
}
EOF
sudo systemctl daemon-reload
sudo systemctl restart docker
```

é˜¿é‡Œäº‘ä¹Ÿæä¾›äº† `dokcer` [é•œåƒçš„åŠ é€ŸæœåŠ¡](https://cr.console.aliyun.com/)ï¼Œä½†æ˜¯è¿™ä¸ªä¹Ÿä¸ç¨³å®šï¼Œå‰å‡ å¤©å¯ä»¥æ‹‰å–é•œåƒï¼Œç°åœ¨æ‹‰å–æ€»æ˜¯æç¤º `timeout` (ä¸é è°±)ğŸ˜…ï¼Œæ‰€ä»¥éœ€è¦è‡ªå·±æ‰¾å¯ç”¨çš„æºã€‚